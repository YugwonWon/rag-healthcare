"""
í‚¤ì›Œë“œ ê¸°ë°˜ ì˜ë„ ë¶„ë¥˜ê¸°
LLM í˜¸ì¶œ ì—†ì´ ê·œì¹™ ê¸°ë°˜ìœ¼ë¡œ ì˜ë„ë¥¼ ë¶„ë¥˜í•˜ì—¬ ì‘ë‹µ ì†ë„ ìœ ì§€

1.2B ì†Œí˜• ëª¨ë¸ í™˜ê²½ì—ì„œ ì¶”ê°€ LLM í˜¸ì¶œì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•´
í‚¤ì›Œë“œ ë§¤ì¹­ + íŒ¨í„´ ê¸°ë°˜ ë¶„ë¥˜ë¥¼ ì‚¬ìš©í•œë‹¤.
"""

import re
from typing import Tuple

from app.graph import Intent
from app.logger import get_logger

logger = get_logger(__name__)


# â”€â”€ ì‘ê¸‰ í‚¤ì›Œë“œ (ìµœìš°ì„  ë§¤ì¹­) â”€â”€
EMERGENCY_KEYWORDS = [
    "ì“°ëŸ¬", "ì˜ì‹", "í˜¸í¡", "ìˆ¨ì„ ëª»", "ìˆ¨ì´ ì•ˆ",
    "ê°€ìŠ´ì´ ì•„", "ê°€ìŠ´ í†µì¦", "ì‹¬ì¥", "ê²½ë ¨", "ë°œì‘",
    "í”¼ë¥¼ í† ", "í”¼ê°€ ë‚˜", "ì¶œí˜ˆ", "ê³¨ì ˆ", "ë¶€ëŸ¬",
    "119", "ì‘ê¸‰", "êµ¬ê¸‰", "ì‚´ë ¤", "ì£½",
    "ë¨¸ë¦¬ë¥¼ ë¶€ë”ª", "ë¨¸ë¦¬ë¥¼ ë‹¤ì³¤", "ë¨¸ë¦¬ì—ì„œ í”¼",
    "í™”ìƒ", "ë¶ˆì— ë°", "ëœ¨ê±°ìš´ ë¬¼",
    "ì•½ì„ ë„ˆë¬´ ë§ì´", "ì•½ ê³¼ë‹¤", "ì¤‘ë…",
    "ëª» ì›€ì§", "ë§ˆë¹„", "ê°ê°ì´ ì—†",
    "ê°‘ìê¸° ë§ì„ ëª»", "ì–¼êµ´ì´ ëŒì•„",
]

# â”€â”€ ê±´ê°• ìƒë‹´ í‚¤ì›Œë“œ â”€â”€
HEALTH_KEYWORDS = [
    # ì¦ìƒ
    "ì•„í”„", "ì•„íŒŒ", "í†µì¦", "ì‘¤ì‹œ", "ì €ë¦¬", "ê°€ë ¤", "ë¶“",
    "ë‘í†µ", "ì–´ì§€ëŸ¬", "ë©”ìŠ¤êº¼", "êµ¬ì—­ì§ˆ", "ì„¤ì‚¬", "ë³€ë¹„", "ì†Œí™”",
    "ì—´ì´", "ê¸°ì¹¨", "ì½§ë¬¼", "ì¬ì±„ê¸°", "ê°ê¸°", "ëª¸ì‚´",
    "ìˆ¨ì´ ì°¨", "ê°€ë˜", "ëª©ì´ ì•„",
    # ìˆ˜ë©´
    "ì ì„ ëª»", "ì ì´ ì•ˆ", "ë¶ˆë©´", "ìˆ˜ë©´", "ë°¤ì— ê¹¨",
    "ìƒˆë²½ì— ê¹¨", "ì ì„ ì„¤", "ê¿ˆì„ ë§ì´",
    # ì§ˆí™˜/ìƒíƒœ
    "ë‹¹ë‡¨", "í˜ˆë‹¹", "í˜ˆì••", "ê³ í˜ˆì••", "ì €í˜ˆì••",
    "ê´€ì ˆ", "ë¼ˆ", "ê·¼ìœ¡", "í—ˆë¦¬", "ë¬´ë¦", "ì–´ê¹¨",
    "ëˆˆì´ ì¹¨ì¹¨", "ë…¸ì•ˆ", "ë°±ë‚´ì¥", "ë…¹ë‚´ì¥",
    "ê·€ê°€ ì•ˆ", "ë‚œì²­", "ì´ëª…",
    "ì¹˜ë§¤", "ê±´ë§ì¦", "ê¸°ì–µ",
    "ë°œí†±", "ì†í†±", "í”¼ë¶€", "íƒˆëª¨", "êµ¬ê°•", "ì‡ëª¸", "ì¹˜ì•„",
    "ê°±ë…„ê¸°", "ê³¨ë‹¤ê³µì¦", "ìš”ì‹¤ê¸ˆ", "ë³€ì‹¤ê¸ˆ",
    "ìš•ì°½", "êµ¬ì¶•", "í", "íë ´",
    # ë¬¸ì˜
    "ë³‘ì›", "ì§„ë£Œ", "ê²€ì‚¬", "ì§„ë‹¨", "ì²˜ë°©", "ì¹˜ë£Œ",
    "ì¦ìƒì´", "ì¦ì„¸", "ìƒíƒœê°€",
]

# â”€â”€ ë³µì•½ í‚¤ì›Œë“œ â”€â”€
MEDICATION_KEYWORDS = [
    "ì•½", "ë³µì•½", "ë³µìš©", "ì²˜ë°©ì „", "ë¨¹ëŠ” ì•½",
    "ë¶€ì‘ìš©", "ì•½ ì´ë¦„", "ì•½ ë¨¹", "ì•½ì„ ì•ˆ",
    "ì–¸ì œ ë¨¹", "ëª‡ ì•Œ", "ì‹ì „", "ì‹í›„",
]

# â”€â”€ ìƒí™œìŠµê´€ í‚¤ì›Œë“œ â”€â”€
LIFESTYLE_KEYWORDS = [
    "ë°¥", "ì‹ì‚¬", "ì‹ë‹¨", "ìŒì‹", "ì˜ì–‘", "ë¹„íƒ€ë¯¼",
    "ìš´ë™", "ì‚°ì±…", "ê±·ê¸°", "ì²´ì¡°", "ìŠ¤íŠ¸ë ˆì¹­",
    "ëª©ìš•", "ì”»", "ìœ„ìƒ",
    "TV", "ì·¨ë¯¸", "ì—¬ê°€", "ì‚°ì±…",
]

# â”€â”€ í›„ì† ì§ˆë¬¸ íŒ¨í„´ (ë§¥ë½ ì˜ì¡´) â”€â”€
FOLLOWUP_PATTERNS = [
    r"^(ê·¸ë˜ì„œ|ê·¸ëŸ¬ë©´|ê·¸ëŸ¼|ê·¸ê²Œ|ê·¸ê±´)[\s?]",
    r"^(ì–´ë–»ê²Œ|ì–´ë–¡|ë­˜|ë¬´ì—‡ì„|ë­˜|ì™œ|ì–¸ì œ|ì–¼ë§ˆë‚˜)[\s?]",
    r"^(ë”|ë˜|ë‹¤ë¥¸|ì¶”ê°€ë¡œ|ê·¸ë¦¬ê³ )[\s]",
    r"^(ê·¸ê±°|ê·¸ê²ƒ|ì´ê±°|ì €ê±°|ê·¸ëŸ°|ì´ëŸ°|ì €ëŸ°)\s",
    r"^(í•´ì•¼|í•˜ë©´|ë˜ë‚˜|ë ê¹Œ|ì¢‹ì„ê¹Œ|ì¢‹ì•„|ë‚˜ì•„|ê´œì°®)",
    r"^(ë„¤|ì‘|ì˜ˆ|ë§ì•„|ì•Œê² |ê·¸ë˜)\s",
    r"^.{1,8}(í•´ì•¼ í•´|í•˜ë©´ ë¼|ì¢‹ì•„\?|ë ê¹Œ|ì¸ê°€ìš”|ì¸ê°€|ê±´ê°€ìš”|ê±´ê°€|í• ê¹Œ)",
    r"^.{1,6}\?$",  # ì§§ì€ ì§ˆë¬¸ (6ê¸€ì ì´í•˜ + ë¬¼ìŒí‘œ)
]

# â”€â”€ ì¼ë°˜ ëŒ€í™” íŒ¨í„´ â”€â”€
GENERAL_CHAT_PATTERNS = [
    r"^(ì•ˆë…•|ë°˜ê°‘|ê°ì‚¬|ê³ ë§ˆ|ì˜ ì§€ë‚´|ì˜¤ë˜ê°„ë§Œ|ì˜¤ëœë§Œ)",
    r"^(ì¢‹ì€ ì•„ì¹¨|ì¢‹ì€ í•˜ë£¨|ì˜ ì|ì˜ ì¤)",
    r"(ë‚ ì”¨|ì˜¤ëŠ˜|ë‚´ì¼|ì–´ì œ|ì£¼ë§|íœ´ì¼)",
    r"^(ì‹¬ì‹¬|ì™¸ë¡œ|ê·¸ë¦¬|ë³´ê³  ì‹¶|ìš¸ì |ê¸°ë¶„)",
    r"^(ë­ í•´|ë­ í•˜|ë­í•´|ë­í•˜)",
]


def classify_intent(
    message: str,
    recent_topic: str = "",
    turn_count: int = 0,
) -> Tuple[Intent, float]:
    """
    ì‚¬ìš©ì ë©”ì‹œì§€ì˜ ì˜ë„ë¥¼ ë¶„ë¥˜í•œë‹¤.

    Returns:
        (Intent, confidence)  confidenceëŠ” 0.0~1.0
    """
    msg = message.strip()
    msg_lower = msg.lower()

    # â”€â”€ 1ë‹¨ê³„: ì‘ê¸‰ ìƒí™© ì²´í¬ (ìµœìš°ì„ ) â”€â”€
    emergency_hits = [kw for kw in EMERGENCY_KEYWORDS if kw in msg_lower]
    if emergency_hits:
        logger.warning(f"ğŸš¨ ì‘ê¸‰ í‚¤ì›Œë“œ ê°ì§€: {emergency_hits}")
        return Intent.EMERGENCY, 0.95

    # â”€â”€ 2ë‹¨ê³„: ì¼ë°˜ ëŒ€í™” ì²´í¬ (ì¸ì‚¬/ê°ì • â€” followupë³´ë‹¤ ìš°ì„ ) â”€â”€
    for pattern in GENERAL_CHAT_PATTERNS:
        if re.search(pattern, msg):
            return Intent.GENERAL_CHAT, 0.8

    # â”€â”€ 3ë‹¨ê³„: í›„ì† ì§ˆë¬¸ íŒë³„ â”€â”€
    # ì§§ì€ ë©”ì‹œì§€(15ì ì´í•˜) + ì´ì „ ëŒ€í™”ê°€ ìˆìœ¼ë©´ í›„ì† ì§ˆë¬¸ ê°€ëŠ¥ì„± ë†’ìŒ
    if turn_count > 0 and recent_topic:
        for pattern in FOLLOWUP_PATTERNS:
            if re.search(pattern, msg):
                logger.debug(f"í›„ì† ì§ˆë¬¸ íŒ¨í„´ ë§¤ì¹­: {pattern}")
                return Intent.FOLLOWUP, 0.85

        # ë§¤ìš° ì§§ì€ ë©”ì‹œì§€ëŠ” í›„ì† ì§ˆë¬¸ìœ¼ë¡œ ê°„ì£¼
        if len(msg) <= 10:
            return Intent.FOLLOWUP, 0.75

    # â”€â”€ 4ë‹¨ê³„: ê±´ê°• ìƒë‹´ ì²´í¬ â”€â”€
    health_hits = [kw for kw in HEALTH_KEYWORDS if kw in msg_lower]
    if len(health_hits) >= 2:
        return Intent.HEALTH_CONSULT, 0.9
    if len(health_hits) == 1:
        return Intent.HEALTH_CONSULT, 0.75

    # â”€â”€ 5ë‹¨ê³„: ë³µì•½ ì²´í¬ â”€â”€
    med_hits = [kw for kw in MEDICATION_KEYWORDS if kw in msg_lower]
    if med_hits:
        return Intent.MEDICATION, 0.8

    # â”€â”€ 6ë‹¨ê³„: ìƒí™œìŠµê´€ ì²´í¬ â”€â”€
    life_hits = [kw for kw in LIFESTYLE_KEYWORDS if kw in msg_lower]
    if len(life_hits) >= 2:
        return Intent.LIFESTYLE, 0.8
    if len(life_hits) == 1:
        return Intent.LIFESTYLE, 0.65

    # â”€â”€ ê¸°ë³¸ê°’: ë©”ì‹œì§€ ê¸¸ì´ ê¸°ë°˜ ì¶”ì • â”€â”€
    if len(msg) <= 10 and turn_count > 0:
        return Intent.FOLLOWUP, 0.6

    return Intent.GENERAL_CHAT, 0.5
